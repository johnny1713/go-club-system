<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœæ£‹ç¤¾é›²ç«¯æ¯”è³½ç³»çµ± - çµ‚æ¥µä¿®æ­£ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #e67e22; --bg-color: #f4f7f6; --white: #ffffff; --beginner-color: #2980b9; --advanced-color: #c0392b; --win-color: #27ae60; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: var(--white); padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2, h3 { text-align: center; color: var(--primary-color); }
        .form-section { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 30px; background: #eee; padding: 20px; border-radius: 8px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-add { background: var(--primary-color); color: white; }
        .admin-bar { text-align: right; margin-bottom: 10px; background: #dfe6e9; padding: 10px; border-radius: 5px; }
        .admin-only { display: none; }
        .is-admin .admin-only { display: inline-block; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 12px; color: white; }
        .tag-entry { background: var(--beginner-color); }
        .tag-adv { background: var(--advanced-color); }
        
        /* æ¨¹ç‹€åœ–ä¿®æ­£ */
        .bracket-wrapper { margin-top: 40px; padding: 25px; border: 2px solid #ddd; border-radius: 10px; background: white; overflow-x: auto; }
        .bracket-container { display: flex; flex-direction: row; padding: 20px; background: #222; border-radius: 8px; color: white; min-height: 400px; min-width: max-content; }
        .round { display: flex; flex-direction: column; justify-content: space-around; width: 220px; margin-right: 50px; flex-shrink: 0; }
        .matchup { background: #333; border: 1px solid #444; border-radius: 6px; margin: 15px 0; padding: 8px; }
        .slot { padding: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; border-bottom: 1px solid #444; min-height: 30px; }
        .slot:last-child { border-bottom: none; }
        .winner-text { color: #f1c40f; font-weight: bold; }
        .btn-win { background: var(--win-color); color: white; padding: 4px 8px; font-size: 11px; border-radius: 3px; border: none; }
        .podium-box { background: #f1c40f; color: #2c3e50; padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center; font-weight: bold; font-size: 18px; }
        .btn-generate { color: white; width: 100%; margin-top: 10px; font-size: 16px; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
    </style>
</head>
<body id="bodyTag">

<div class="container">
    <h1>åœæ£‹ç¤¾é›²ç«¯æ¯”è³½ç³»çµ±</h1>

    <div class="admin-bar">
        <input type="password" id="adminPw" placeholder="å¯†ç¢¼ admin123" style="width:120px">
        <button onclick="toggleAdmin()">ç®¡ç†å“¡ç™»å…¥</button>
        <button onclick="location.reload()" style="background:#636e72; color:white;">å¼·åˆ¶åˆ·æ–°é é¢</button>
    </div>

    <div class="form-section">
        <input type="text" id="userName" placeholder="å§“å">
        <input type="text" id="userId" placeholder="å·¥è™Ÿ">
        <select id="userLevel">
            <option value="å…¥é–€">å…¥é–€çµ„</option>
            <option value="é€²éš">é€²éšçµ„</option>
        </select>
        <button class="btn-add" onclick="register()">æäº¤å ±å</button>
    </div>

    <h2>ç›®å‰å ±ååå–®</h2>
    <table>
        <thead><tr><th>å§“å</th><th>å·¥è™Ÿ</th><th>çµ„åˆ¥</th><th>æ™‚é–“</th><th class="admin-only">æ“ä½œ</th></tr></thead>
        <tbody id="regList"></tbody>
    </table>

    <hr style="margin: 40px 0;">

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <button class="btn-generate" style="background:var(--beginner-color)" onclick="createTournament('å…¥é–€')">ç”Ÿæˆã€å…¥é–€çµ„ã€‘å°æˆ°è¡¨</button>
        <button class="btn-generate" style="background:var(--advanced-color)" onclick="createTournament('é€²éš')">ç”Ÿæˆã€é€²éšçµ„ã€‘å°æˆ°è¡¨</button>
    </div>

    <div id="area-å…¥é–€" class="bracket-wrapper" style="display:none;"></div>
    <div id="area-é€²éš" class="bracket-wrapper" style="display:none;"></div>
</div>

<script>
    // 1. Firebase é…ç½® (è«‹å‹™å¿…æ›æˆä½ è‡ªå·±çš„ï¼)
    const firebaseConfig = {
		apiKey: "AIzaSyDNmDH2jTCu9miZtzTM73H1gLYJ3EOazsQ",
		authDomain: "go-club-818e2.firebaseapp.com",
		databaseURL: "https://go-club-818e2-default-rtdb.firebaseio.com",
		projectId: "go-club-818e2",
		storageBucket: "go-club-818e2.firebasestorage.app",
		messagingSenderId: "818869551072",
		appId: "1:818869551072:web:8408991a2dedd1f9e1b585",
		measurementId: "G-3S2G8R5QJD"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let participants = [];
    let tournaments = { 'å…¥é–€': null, 'é€²éš': null };
    let isAdmin = false;

    // ç›£è½åå–®
    db.ref('players').on('value', (snap) => {
        const data = snap.val();
        participants = data ? Object.entries(data).map(([key, val]) => ({...val, fbKey: key})) : [];
        renderAll();
    });

    // ç›£è½è³½ç¨‹
    db.ref('tournaments').on('value', (snap) => {
        tournaments = snap.val() || { 'å…¥é–€': null, 'é€²éš': null };
        renderAll();
    });

    function toggleAdmin() {
        if (document.getElementById('adminPw').value === "admin123") {
            isAdmin = !isAdmin;
            document.getElementById('bodyTag').classList.toggle('is-admin');
            alert(isAdmin ? "å·²é€²å…¥ç®¡ç†æ¨¡å¼ï¼Œç¾åœ¨å¯ä»¥çœ‹åˆ°ã€å‹ã€æŒ‰éˆ•äº†ï¼" : "å·²ç™»å‡ºç®¡ç†æ¨¡å¼");
            renderAll();
        } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
    }

    function register() {
        const name = document.getElementById('userName').value;
        const id = document.getElementById('userId').value;
        const level = document.getElementById('userLevel').value;
        if (!name || !id) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
        db.ref('players').push({ name, id, level, time: new Date().toLocaleString() });
        document.getElementById('userName').value = '';
        document.getElementById('userId').value = '';
    }

    function deletePlayer(key) { if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) db.ref('players/' + key).remove(); }

    // ç”Ÿæˆå°æˆ°è¡¨ (ä¿®æ­£çµæ§‹å•é¡Œ)
    function createTournament(level) {
        const players = participants.filter(p => p.level === level);
        if (players.length < 2) return alert("äººæ•¸ä¸è¶³ (è‡³å°‘ 2 äºº)");
        if (!isAdmin) return alert("è«‹å…ˆç™»å…¥ç®¡ç†å“¡æ‰èƒ½ç”Ÿæˆå°æˆ°è¡¨ï¼");
        if (!confirm("é‡æ–°ç”Ÿæˆå°‡æœƒæ¸…ç©ºç›®å‰ " + level + " çµ„çš„æ‰€æœ‰é€²åº¦ï¼Œç¢ºå®šï¼Ÿ")) return;

        const roundCount = Math.ceil(Math.log2(players.length));
        const totalSlots = Math.pow(2, roundCount);
        let shuffled = [...players].sort(() => Math.random() - 0.5);

        let bracket = [];
        for (let r = 0; r < roundCount; r++) {
            let mCount = Math.pow(2, roundCount - r - 1);
            bracket.push(new Array(mCount).fill(null).map(() => ({ p1: null, p2: null, winner: null, loser: null })));
        }

        let newStruct = {
            level: level,
            bracket: bracket,
            thirdPlaceMatch: { p1: null, p2: null, winner: null, loser: null }
        };

        // å¡«å……ç¬¬ä¸€è¼ª
        for (let i = 0; i < totalSlots; i += 2) {
            const mIdx = i / 2;
            const p1 = shuffled[i] || { name: "è¼ªç©º", id: "BYE" };
            const p2 = shuffled[i+1] || { name: "è¼ªç©º", id: "BYE" };
            newStruct.bracket[0][mIdx].p1 = p1;
            newStruct.bracket[0][mIdx].p2 = p2;

            if (p2.id === "BYE") {
                newStruct.bracket[0][mIdx].winner = p1;
                advanceLogic(newStruct, 0, mIdx, p1, null);
            } else if (p1.id === "BYE") {
                newStruct.bracket[0][mIdx].winner = p2;
                advanceLogic(newStruct, 0, mIdx, p2, null);
            }
        }
        db.ref('tournaments/' + level).set(newStruct);
    }

    // æ ¸å¿ƒæ™‰ç´šé‚è¼¯
    function advanceLogic(struct, rIdx, mIdx, winner, loser) {
        const nextRound = rIdx + 1;
        // å­£è»è³½ï¼šæº–æ±ºè³½çš„è¼¸å®¶é€²å…¥å­£è»è³½
        if (rIdx === struct.bracket.length - 2 && loser && loser.id !== "BYE") {
            if (mIdx === 0) struct.thirdPlaceMatch.p1 = loser;
            else struct.thirdPlaceMatch.p2 = loser;
        }
        // æ™‰ç´šä¸‹ä¸€è¼ª
        if (nextRound < struct.bracket.length) {
            const nextMIdx = Math.floor(mIdx / 2);
            if (mIdx % 2 === 0) struct.bracket[nextRound][nextMIdx].p1 = winner;
            else struct.bracket[nextRound][nextMIdx].p2 = winner;
        }
    }

    function setWin(level, rIdx, mIdx, pNum) {
        const struct = tournaments[level];
        if (!struct || !struct.bracket) return;
        const match = struct.bracket[rIdx][mIdx];
        const winner = (pNum === 1) ? match.p1 : match.p2;
        const loser = (pNum === 1) ? match.p2 : match.p1;
        
        match.winner = winner;
        match.loser = loser;
        advanceLogic(struct, rIdx, mIdx, winner, loser);
        db.ref('tournaments/' + level).set(struct);
    }

    function setThirdWin(level, pNum) {
        const struct = tournaments[level];
        const match = struct.thirdPlaceMatch;
        match.winner = (pNum === 1) ? match.p1 : match.p2;
        match.loser = (pNum === 1) ? match.p2 : match.p1;
        db.ref('tournaments/' + level).set(struct);
    }

    function renderAll() {
        // åå–®
        const list = document.getElementById('regList');
        list.innerHTML = participants.map(p => `<tr><td>${p.name}</td><td>${p.id}</td><td><span class="tag ${p.level==='å…¥é–€'?'tag-entry':'tag-adv'}">${p.level}</span></td><td>${p.time}</td><td class="admin-only"><button onclick="deletePlayer('${p.fbKey}')" style="background:#e74c3c;color:white;">åˆªé™¤</button></td></tr>`).join('');

        ['å…¥é–€', 'é€²éš'].forEach(lvl => {
            const area = document.getElementById('area-' + lvl);
            const struct = tournaments[lvl];
            // å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœçµæ§‹ä¸å°å°±ä¸æ¸²æŸ“
            if (!struct || !struct.bracket) { area.style.display = 'none'; return; }
            
            area.style.display = 'block';
            area.innerHTML = `<h3>ğŸ† ${lvl}çµ„ è³½ç¨‹é€²åº¦</h3>`;
            
            const bBox = document.createElement('div'); bBox.className = 'bracket-container';
            struct.bracket.forEach((round, rIdx) => {
                const rDiv = document.createElement('div'); rDiv.className = 'round';
                rDiv.innerHTML = `<h4>ç¬¬ ${rIdx+1} è¼ª</h4>`;
                round.forEach((m, mIdx) => {
                    rDiv.innerHTML += `
                        <div class="matchup">
                            <div class="slot ${m.winner?.id===m.p1?.id && m.winner ? 'winner-text' : ''}">
                                <span>${m.p1 ? m.p1.name : '...'}</span>
                                ${isAdmin && m.p1 && !m.winner && m.p1.id!=='BYE' ? `<button class="btn-win" onclick="setWin('${lvl}',${rIdx},${mIdx},1)">å‹</button>` : ''}
                            </div>
                            <div class="slot ${m.winner?.id===m.p2?.id && m.winner ? 'winner-text' : ''}">
                                <span>${m.p2 ? m.p2.name : '...'}</span>
                                ${isAdmin && m.p2 && !m.winner && m.p2.id!=='BYE' ? `<button class="btn-win" onclick="setWin('${lvl}',${rIdx},${mIdx},2)">å‹</button>` : ''}
                            </div>
                        </div>`;
                });
                bBox.appendChild(rDiv);
            });
            area.appendChild(bBox);

            const tm = struct.thirdPlaceMatch;
            if (tm && (tm.p1 || tm.p2)) {
                const tBox = document.createElement('div'); tBox.style.cssText = "margin-top:20px; text-align:center;";
                tBox.innerHTML = `
                    <div style="background:#444; color:white; padding:15px; border-radius:8px; display:inline-block; width:260px; border:1px solid #e67e22;">
                        <div style="font-size:12px; color:#e67e22; margin-bottom:5px;">ğŸ¥‰ å­£è»è³½</div>
                        <div class="slot ${tm.winner?.id===tm.p1?.id && tm.winner ? 'winner-text' : ''}"><span>${tm.p1?tm.p1.name:'...'}</span>${isAdmin&&tm.p1&&!tm.winner?`<button class="btn-win" onclick="setThirdWin('${lvl}',1)">å‹</button>`:''}</div>
                        <div class="slot ${tm.winner?.id===tm.p2?.id && tm.winner ? 'winner-text' : ''}"><span>${tm.p2?tm.p2.name:'...'}</span>${isAdmin&&tm.p2&&!tm.winner?`<button class="btn-win" onclick="setThirdWin('${lvl}',2)">å‹</button>`:''}</div>
                    </div>`;
                area.appendChild(tBox);
            }

            const final = struct.bracket[struct.bracket.length-1][0];
            if (final.winner && tm && tm.winner) {
                const pBox = document.createElement('div'); pBox.className = 'podium-box';
                pBox.innerHTML = `ğŸ¥‡ å† è»ï¼š${final.winner.name} | ğŸ¥ˆ äºè»ï¼š${final.loser.name}<br>ğŸ¥‰ å­£è»ï¼š${tm.winner.name} | ğŸ… æ®¿è»ï¼š${tm.loser.name}`;
                area.appendChild(pBox);
            }
        });
    }
</script>
</body>
</html>
