<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœæ£‹ç¤¾æ¯”è³½ç³»çµ± (ç‘å£«åˆ¶é˜²å‘†ç‰ˆ)</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #d35400;
            --bg: #fdfbf7;
            --board-color: #e6b35c;
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: var(--primary); cursor: pointer; user-select: none; }
        h2 { border-bottom: 2px solid var(--board-color); padding-bottom: 10px; margin-top: 30px;}

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; background: #eee; border-radius: 5px 5px 0 0; }
        .tab.active { background: var(--primary); color: white; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Form */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { opacity: 0.9; }
        button.danger { background: #c0392b; }
        button.success { background: #27ae60; }
        button.warning { background: #f39c12; }
        button.admin-btn { background: var(--accent); display: none; margin-left: 10px; }
        button.logout-btn { background: #7f8c8d; font-size: 0.8em; padding: 5px 10px; margin-top: 5px; }

        /* Admin Controls */
        .admin-controls-panel {
            display: none;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .registration-closed-msg { display: none; color: #c0392b; font-weight: bold; text-align: center; padding: 10px; border: 1px dashed #c0392b; background: #fdedec; margin-top: 10px; }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: var(--primary); color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }

        /* Match Styles */
        .match { background: #fff; border: 1px solid #ccc; margin: 10px 0; padding: 10px; border-radius: 4px; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .match:hover { border-color: var(--accent); }
        
        .player { padding: 5px; display: flex; justify-content: space-between; align-items: center; cursor: default; border-radius: 3px; }
        .player.winner { font-weight: bold; color: green; }
        .player.loser { color: #999; text-decoration: line-through; }
        .player.bye-text { color: #999; font-style: italic; }
        
        /* Admin Interaction Styles */
        body.is-admin .player.clickable:hover { background-color: #ffeaa7; cursor: pointer; outline: 1px solid orange; }
        body.is-admin .player.undoable:hover { background-color: #ffcccc; cursor: pointer; outline: 1px solid red; }
        /* Disabled interaction for old rounds */
        body.is-admin .player.locked { cursor: not-allowed; opacity: 0.6; }

        /* Swiss Round Section */
        .swiss-round-container { margin-bottom: 30px; border: 1px solid #eee; padding: 15px; border-radius: 8px; background: #fff; }
        .swiss-round-title { font-weight: bold; font-size: 1.2em; color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 5px; margin-bottom: 10px; }
        
        .rr-standings th { background-color: var(--accent); }
        .rank-1 { color: gold; font-weight: bold; text-shadow: 1px 1px 0 #999; }
        .rank-2 { color: silver; font-weight: bold; text-shadow: 1px 1px 0 #999; }
        .rank-3 { color: #cd7f32; font-weight: bold; text-shadow: 1px 1px 0 #999; }

        /* Tag Styles */
        .tag { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.9em; display: inline-block; font-weight: bold; text-align: center; min-width: 60px;}
        .tag-beginner { background-color: #27ae60; }
        .tag-advanced { background-color: #c0392b; }
        .time-text { font-size: 0.85em; color: #666; }

        /* Admin Mode */
        body.is-admin .admin-btn { display: inline-block; }
        body.is-admin .admin-action { display: table-cell; }
        body.is-admin .admin-controls-panel { display: block; }
        .admin-action { display: none; width: 80px; text-align: center; }
        
        /* RR Grid Styles */
        .rr-grid th, .rr-grid td { text-align: center; vertical-align: middle; padding: 15px; border: 1px solid #ccc; font-size: 1.1em; }
        .rr-cell-self { background-color: #eee; }
        .rr-cell-win { background-color: #d4edda; color: #155724; font-weight: bold; }
        .rr-cell-loss { background-color: #f8d7da; color: #721c24; }
        .rr-cell-play { background-color: #fff; color: #aaa; } 
        body.is-admin .rr-cell-clickable { cursor: pointer !important; position: relative; }
        body.is-admin .rr-cell-clickable:hover { background-color: #ffeaa7 !important; outline: 2px solid var(--accent); z-index: 10; }

        .edit-input { width: 100px; padding: 2px; }
        .admin-select { width: auto; padding: 5px; border-color: var(--accent); }
    </style>
</head>
<body>

<div class="container">
    <h1 id="appTitle" title="åœæ£‹ç¤¾å…§éƒ¨æ¯”è³½ç³»çµ±">åœæ£‹ç¤¾å…§éƒ¨æ¯”è³½ç³»çµ±</h1>
    <div id="adminStatus" style="text-align:center; color: red; display:none;">
        (ç®¡ç†å“¡æ¨¡å¼å·²å•Ÿç”¨)<br>
        <span style="font-size:0.8em; color:#666;">ğŸ’¡ æç¤ºï¼šé»æ“Šã€Œæ ¼å­ã€æˆ–ã€Œåå­—ã€åˆ‡æ›å‹è²  (æ­·å²è¼ªæ¬¡æœƒé–å®š)</span><br>
        <button class="logout-btn" onclick="logout()">ç™»å‡ºç®¡ç†å“¡</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('register')">å ±åé é¢</div>
        <div class="tab" onclick="switchTab('list')">å ±ååå–®</div>
        <div class="tab" onclick="switchTab('bracket-beginner')">å…¥é–€çµ„å°æˆ°è¡¨</div>
        <div class="tab" onclick="switchTab('bracket-advanced')">é€²éšçµ„å°æˆ°è¡¨</div>
    </div>

    <div id="register" class="tab-content active">
        <h2>é¸æ‰‹å ±å</h2>
        <div class="admin-controls-panel">
            <strong>ğŸ”§ ç®¡ç†å“¡æ§åˆ¶ï¼š</strong>
            <button class="success" onclick="toggleRegistration(true)">ğŸŸ¢ é–‹å•Ÿå ±å</button>
            <button class="danger" onclick="toggleRegistration(false)">ğŸ”´ æˆªæ­¢å ±å</button>
            <span id="adminRegStatus" style="margin-left:10px; font-weight:bold;"></span>
        </div>

        <div id="registrationForm">
            <div class="form-group">
                <label>çµ„åˆ¥</label>
                <select id="regCategory">
                    <option value="beginner">å…¥é–€çµ„ (ç‘å£«åˆ¶)</option>
                    <option value="advanced">é€²éšçµ„ (å¾ªç’°è³½)</option>
                </select>
            </div>
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="regName" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <div class="form-group">
                <label>å·¥è™Ÿ</label>
                <input type="text" id="regEmpId" placeholder="è«‹è¼¸å…¥å·¥è™Ÿ">
            </div>
            <button id="submitBtn" onclick="submitRegistration()">æäº¤å ±å</button>
        </div>

        <div id="regClosedMsg" class="registration-closed-msg">
            âš ï¸ ç›®å‰å ±åå·²æˆªæ­¢ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚
        </div>
    </div>

    <div id="list" class="tab-content">
        <h2>å·²å ±ååå–®</h2>
        <table>
            <thead>
                <tr>
                    <th style="width: 120px;">çµ„åˆ¥</th>
                    <th>å§“å</th>
                    <th>å·¥è™Ÿ</th>
                    <th>å ±åæ™‚é–“</th>
                    <th class="admin-action">ç®¡ç†æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="registrantsTable"></tbody>
        </table>
    </div>

    <div id="bracket-beginner" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>å…¥é–€çµ„ å°æˆ°è¡¨ (ç‘å£«åˆ¶ Swiss System)</h2>
            <div>
                <button class="admin-btn warning" onclick="deleteLastSwissRound('beginner')">ğŸ”™ åˆªé™¤æœ€å¾Œä¸€è¼ª</button>
                <button class="admin-btn danger" onclick="clearBracket('beginner')">ğŸ—‘ï¸ æ¸…ç©ºè³½ç¨‹</button>
                <button class="admin-btn success" onclick="generateNextSwissRound('beginner')">â• ç”¢ç”Ÿä¸‹ä¸€è¼ª</button>
            </div>
        </div>
        
        <p style="color:#666; font-size:0.9em; margin:10px 0;">
            ğŸ’¡ ç‘å£«åˆ¶è¦å‰‡ï¼šä¸ç”¨æ·˜æ±°ï¼Œç³»çµ±è‡ªå‹•é…å°ã€‚è‹¥éœ€ä¿®æ”¹æ­·å²æˆç¸¾ï¼Œè«‹å…ˆã€Œåˆªé™¤æœ€å¾Œä¸€è¼ªã€å›åˆ°è©²è¼ªæ¬¡ã€‚
        </p>

        <div id="beginner-swiss-rounds"></div>

        <h3>ğŸ† å…¥é–€çµ„ æˆ°ç¸¾æ’è¡Œæ¦œ</h3>
        <table class="rr-standings">
            <thead>
                <tr><th>åæ¬¡</th><th>å§“å</th><th>ä¸»åˆ† (å‹å ´)</th><th>è¼”åˆ† (å°æ‰‹å‹å ´å’Œ)</th><th>å°æˆ°ç´€éŒ„</th></tr>
            </thead>
            <tbody id="beginner-standings-body"></tbody>
        </table>
    </div>

    <div id="bracket-advanced" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>é€²éšçµ„ å°æˆ°è¡¨ (å¾ªç’°è³½ Round Robin)</h2>
            <div>
                <button class="admin-btn danger" onclick="clearBracket('advanced')">ğŸ—‘ï¸ æ¸…ç©ºå°æˆ°è¡¨</button>
                <button class="admin-btn" onclick="generateRoundRobinBracket()">é‡æ–°ç”¢ç”Ÿ</button>
            </div>
        </div>
        
        <h3>ğŸ† é€²éšçµ„ æˆ°ç¸¾æ’è¡Œæ¦œ</h3>
        <table class="rr-standings">
            <thead>
                <tr>
                    <th>åæ¬¡</th>
                    <th>å§“å</th>
                    <th>å‹</th>
                    <th>æ•—</th>
                    <th>å‹ç‡</th>
                </tr>
            </thead>
            <tbody id="advanced-standings-body"></tbody>
        </table>

        <h3>âš”ï¸ å°æˆ°çŸ©é™£</h3>
        <p style="font-size:0.9em; color:#666;">(æ©«åˆ—ç‚ºé¸æ‰‹ï¼Œç›´æ¬„ç‚ºå°æ‰‹ã€‚è‹¥æ‚¨æ˜¯ç®¡ç†å“¡ï¼Œè«‹é»æ“Šæ ¼å­åˆ‡æ›ï¼šå‹ -> æ•— -> æœªæˆ°)</p>
        <div id="advanced-grid-area" style="overflow-x: auto;"></div>
    </div>
</div>

<script>
    // 1. åˆå§‹åŒ–è®Šæ•¸
    let clickCount = 0;
    let isAdmin = false;
    let isRegistrationOpen = true; 
    let allUsers = [];
    let bracketData = { beginner: null, advanced: null };
    
    const targetHash = "43b2d122712ab1d4778f7d4ff86337f7c9aeb6d5e3ac0d0626e7288258f6a836";

    const firebaseConfig = {
        apiKey: "AIzaSyDNmDH2jTCu9miZtzTM73H1gLYJ3EOazsQ",
        authDomain: "go-club-818e2.firebaseapp.com",
        databaseURL: "https://go-club-818e2-default-rtdb.firebaseio.com",
        projectId: "go-club-818e2",
        storageBucket: "go-club-818e2.firebasestorage.app",
        messagingSenderId: "818869551072",
        appId: "1:818869551072:web:8408991a2dedd1f9e1b585",
        measurementId: "G-3S2G8R5QJD"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. å•Ÿå‹•é‚è¼¯
    if (localStorage.getItem('goClubAdmin') === 'true') {
        enableAdminMode();
    }

    db.ref('config/registrationOpen').on('value', (snapshot) => {
        const val = snapshot.val();
        isRegistrationOpen = (val === null) ? true : val;
        updateRegistrationUI();
    });

    // 3. ç®¡ç†å“¡åŠŸèƒ½ (åŠ å¯†ç‰ˆ)
    async function sha256(message) {
        if (!window.crypto || !window.crypto.subtle) {
            alert("âš ï¸ å®‰å…¨è­¦å‘Šï¼šæ‚¨çš„ç€è¦½å™¨ç’°å¢ƒ (å¦‚ç›´æ¥é–‹å•Ÿ file://) ä¸æ”¯æ´åŠ å¯† APIã€‚\nè‹¥è¦ä½¿ç”¨å¯†ç¢¼åŠŸèƒ½ï¼Œè«‹å°‡ç¶²é éƒ¨ç½²åˆ°ä¼ºæœå™¨æˆ–ä½¿ç”¨ Localhostã€‚");
            throw new Error("Crypto API not available");
        }
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    document.getElementById('appTitle').addEventListener('click', async () => {
        clickCount++;
        if (clickCount === 16) {
            if (isAdmin) return; 
            
            if (!window.crypto || !window.crypto.subtle) {
                 alert("âš ï¸ ç„¡æ³•ç™»å…¥ï¼šæ‚¨çš„ç’°å¢ƒ (file://) ä¸æ”¯æ´åŠ å¯†é©—è­‰ã€‚\nè«‹ä½¿ç”¨ Local Server (å¦‚ VSCode Live Server) é–‹å•Ÿæ­¤ç¶²é ã€‚");
                 clickCount = 0;
                 return;
            }

            const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
            if (pwd) {
                try {
                    const inputHash = await sha256(pwd);
                    if (inputHash === targetHash) {
                        enableAdminMode();
                        alert("ç®¡ç†å“¡æ¨¡å¼å·²é–‹å•Ÿ");
                    } else {
                        alert("å¯†ç¢¼éŒ¯èª¤");
                    }
                } catch (e) {
                    console.error(e);
                    alert("é©—è­‰éç¨‹ç™¼ç”ŸéŒ¯èª¤ (è«‹ç¢ºèªæ˜¯å¦ä½¿ç”¨ https æˆ– localhost)");
                }
            }
            clickCount = 0;
        }
    });

    function enableAdminMode() {
        isAdmin = true;
        localStorage.setItem('goClubAdmin', 'true');
        document.body.classList.add('is-admin');
        document.getElementById('adminStatus').style.display = 'block';
        updateRegistrationUI();
        renderList();
        refreshBrackets(); 
    }

    function logout() {
        isAdmin = false;
        localStorage.removeItem('goClubAdmin');
        document.body.classList.remove('is-admin');
        document.getElementById('adminStatus').style.display = 'none';
        updateRegistrationUI();
        renderList();
        refreshBrackets(); 
    }

    function toggleRegistration(status) {
        db.ref('config/registrationOpen').set(status);
        alert(status ? "å ±åå·²é–‹å•Ÿ" : "å ±åå·²æˆªæ­¢");
    }

    function updateRegistrationUI() {
        const formDiv = document.getElementById('registrationForm');
        const closedMsg = document.getElementById('regClosedMsg');
        const adminStatusLabel = document.getElementById('adminRegStatus');
        adminStatusLabel.innerText = isRegistrationOpen ? "(ç›®å‰ç‹€æ…‹ï¼šé–‹å•Ÿ)" : "(ç›®å‰ç‹€æ…‹ï¼šæˆªæ­¢)";
        adminStatusLabel.style.color = isRegistrationOpen ? "green" : "red";

        if (isAdmin) {
            formDiv.style.display = 'block';
            closedMsg.style.display = 'none';
        } else {
            if (isRegistrationOpen) {
                formDiv.style.display = 'block';
                closedMsg.style.display = 'none';
            } else {
                formDiv.style.display = 'none';
                closedMsg.style.display = 'block';
            }
        }
    }

    function refreshBrackets() {
        if(bracketData.beginner) renderSwissUI('beginner', bracketData.beginner);
        if(bracketData.advanced) renderRoundRobinUI(bracketData.advanced);
    }

    // 4. ä¸€èˆ¬åŠŸèƒ½
    function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const tabs = ['register', 'list', 'bracket-beginner', 'bracket-advanced'];
        const index = tabs.indexOf(tabId);
        document.querySelectorAll('.tab')[index].classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    function submitRegistration() {
        if (!isRegistrationOpen && !isAdmin) { alert("æŠ±æ­‰ï¼Œå ±åå·²æˆªæ­¢ã€‚"); return; }
        const name = document.getElementById('regName').value.trim();
        const empId = document.getElementById('regEmpId').value.trim();
        const category = document.getElementById('regCategory').value;
        if (!name || !empId) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š"); return; }
        const isDuplicate = allUsers.some(u => u.empId === empId);
        if (isDuplicate) { alert("æ­¤å·¥è™Ÿå·²å ±åéï¼Œè«‹å‹¿é‡è¤‡å ±åï¼"); return; }
        db.ref('users').push({ name, empId, category, timestamp: new Date().toISOString() })
          .then(() => { alert("å ±åæˆåŠŸï¼"); document.getElementById('regName').value = ''; document.getElementById('regEmpId').value = ''; switchTab('list'); });
    }

    db.ref('users').on('value', (snapshot) => {
        const data = snapshot.val();
        allUsers = [];
        if (data) Object.keys(data).forEach(key => allUsers.push({ id: key, ...data[key] }));
        renderList();
    });

    function renderList() {
        const tbody = document.getElementById('registrantsTable');
        tbody.innerHTML = '';
        allUsers.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        allUsers.forEach(user => {
            const dateStr = new Date(user.timestamp).toLocaleString('zh-TW');
            const catText = user.category === 'beginner' ? 'å…¥é–€' : 'é€²éš';
            const catClass = user.category === 'beginner' ? 'tag-beginner' : 'tag-advanced';
            let categoryHtml = isAdmin ? 
                `<select class="admin-select" onchange='updateUser("${user.id}", "category", this.value)'>
                    <option value="beginner" ${user.category === 'beginner' ? 'selected' : ''}>å…¥é–€çµ„</option>
                    <option value="advanced" ${user.category === 'advanced' ? 'selected' : ''}>é€²éšçµ„</option>
                </select>` : `<span class="tag ${catClass}">${catText}</span>`;
            
            tbody.innerHTML += `<tr>
                <td>${categoryHtml}</td>
                <td>${isAdmin ? `<input class='edit-input' value='${user.name}' onchange='updateUser("${user.id}", "name", this.value)'>` : user.name}</td>
                <td>${isAdmin ? `<input class='edit-input' value='${user.empId}' onchange='updateUser("${user.id}", "empId", this.value)'>` : user.empId}</td>
                <td class="time-text">${dateStr}</td>
                <td class="admin-action"><button class="danger" onclick="deleteUser('${user.id}')">åˆªé™¤</button></td>
            </tr>`;
        });
    }

    function updateUser(id, field, value) { db.ref('users/' + id).update({ [field]: value }); }
    function deleteUser(id) { if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ä½å ±åè€…å—ï¼Ÿ")) db.ref('users/' + id).remove(); }

    // 5. å°æˆ°è¡¨ç®¡ç†
    function clearBracket(category) {
        if (!confirm(`ç¢ºå®šè¦æ¸…ç©ºã€${category === 'beginner' ? 'å…¥é–€çµ„' : 'é€²éšçµ„'}ã€‘çš„è³½ç¨‹å—ï¼Ÿ\n(å ±åè³‡æ–™æœƒä¿ç•™)`)) return;
        db.ref(`tournament/${category}`).remove().then(() => alert("è³½ç¨‹å·²æ¸…ç©º"));
    }

    // --- å›æº¯åŠŸèƒ½ (New!) ---
    window.deleteLastSwissRound = function(category) {
        if (!isAdmin) return;
        if (!bracketData[category] || !bracketData[category].rounds || bracketData[category].rounds.length === 0) {
            alert("æ²’æœ‰å¯ä»¥åˆªé™¤çš„è¼ªæ¬¡ï¼");
            return;
        }
        
        const currentRounds = bracketData[category].rounds;
        const roundNum = currentRounds.length;
        
        if (!confirm(`âš ï¸ å±éšªæ“ä½œï¼š\nç¢ºå®šè¦åˆªé™¤ã€Œç¬¬ ${roundNum} è¼ªã€çš„å°æˆ°å—ï¼Ÿ\n\n(é€™é€šå¸¸ç”¨æ–¼ä¿®æ­£ä¸Šä¸€è¼ªçš„æˆç¸¾éŒ¯èª¤)`)) return;

        // ç§»é™¤æœ€å¾Œä¸€è¼ª
        currentRounds.pop();
        
        db.ref(`tournament/${category}/rounds`).set(currentRounds)
            .then(() => alert(`å·²åˆªé™¤ç¬¬ ${roundNum} è¼ªï¼Œç¾åœ¨æ‚¨å¯ä»¥ä¿®æ”¹ç¬¬ ${roundNum - 1} è¼ªçš„æˆç¸¾äº†ã€‚`));
    }

    // --- ç‘å£«åˆ¶ç”Ÿæˆé‚è¼¯ (å…¥é–€çµ„) ---
    function generateNextSwissRound() {
        if (!confirm(`ç¢ºå®šè¦ç”¢ç”Ÿã€å…¥é–€çµ„ã€‘ä¸‹ä¸€è¼ªå°æˆ°å—ï¼Ÿ`)) return;

        let participants = allUsers.filter(u => u.category === 'beginner').map(u => ({ name: u.name, id: u.id, wins: 0, played: [] }));
        
        let rounds = [];
        if (bracketData.beginner && bracketData.beginner.rounds) {
            rounds = bracketData.beginner.rounds;
            const lastRound = rounds[rounds.length - 1];
            const unfinished = lastRound.some(m => !m.winner);
            if (unfinished) { alert("ä¸Šä¸€è¼ªé‚„æœ‰æ¯”è³½æœªå®Œæˆï¼"); return; }
            
            rounds.forEach(round => {
                round.forEach(m => {
                    if (m.winner) {
                        const winner = participants.find(p => p.id === m.winner);
                        const loser = participants.find(p => p.id === (m.winner === m.p1.id ? m.p2.id : m.p1.id));
                        if(winner) { winner.wins++; winner.played.push(loser ? loser.id : 'BYE'); }
                        if(loser) { loser.played.push(winner ? winner.id : 'BYE'); }
                    }
                });
            });
        } else {
             for (let i = participants.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [participants[i], participants[j]] = [participants[j], participants[i]];
            }
        }

        participants.sort((a, b) => b.wins - a.wins || 0.5 - Math.random());

        const newRoundMatches = [];
        const paired = new Set();

        for (let i = 0; i < participants.length; i++) {
            const p1 = participants[i];
            if (paired.has(p1.id)) continue;

            let p2 = null;
            for (let j = i + 1; j < participants.length; j++) {
                const candidate = participants[j];
                if (!paired.has(candidate.id) && !p1.played.includes(candidate.id)) {
                    p2 = candidate;
                    break;
                }
            }
            if (!p2) {
                for (let j = i + 1; j < participants.length; j++) {
                    if (!paired.has(participants[j].id)) {
                        p2 = participants[j];
                        break;
                    }
                }
            }

            if (p2) {
                newRoundMatches.push({ p1: {name: p1.name, id: p1.id}, p2: {name: p2.name, id: p2.id}, winner: null });
                paired.add(p1.id);
                paired.add(p2.id);
            } else {
                newRoundMatches.push({ p1: {name: p1.name, id: p1.id}, p2: {name: "è¼ªç©º", id: "BYE"}, winner: p1.id });
                paired.add(p1.id);
            }
        }

        rounds.push(newRoundMatches);
        db.ref(`tournament/beginner`).set({
            type: 'swiss',
            rounds: rounds,
            timestamp: Date.now()
        });
    }

    // --- å¾ªç’°è³½ç”Ÿæˆé‚è¼¯ (é€²éšçµ„) ---
    function generateRoundRobinBracket() {
        if (!confirm("ç¢ºå®šè¦ç”¢ç”Ÿã€é€²éšçµ„ã€‘å¾ªç’°è³½å°æˆ°è¡¨å—ï¼Ÿ")) return;
        let participants = allUsers.filter(u => u.category === 'advanced').map(u => ({ name: u.name, id: u.id }));
        if (participants.length < 2) { alert("äººæ•¸ä¸è¶³"); return; }

        let matches = [];
        for (let i = 0; i < participants.length; i++) {
            for (let j = i + 1; j < participants.length; j++) {
                matches.push({
                    p1: participants[i],
                    p2: participants[j],
                    winner: null
                });
            }
        }

        db.ref(`tournament/advanced`).set({
            type: 'round-robin',
            participants: participants,
            matches: matches,
            timestamp: Date.now()
        });
    }

    // 6. æ¸²æŸ“é‚è¼¯
    db.ref(`tournament/beginner`).on('value', snapshot => {
        const data = snapshot.val();
        bracketData.beginner = data;
        if (data) {
            renderSwissUI('beginner', data);
        } else {
            document.getElementById('beginner-swiss-rounds').innerHTML = '<p style="padding:20px; color:#666;">å°šæœªç”¢ç”Ÿå°æˆ°è¡¨</p>';
            document.getElementById('beginner-standings-body').innerHTML = ''; // æ¸…ç©ºæˆ°ç¸¾æ¦œ
        }
    });

    db.ref(`tournament/advanced`).on('value', snapshot => {
        const data = snapshot.val();
        bracketData.advanced = data;
        if (data) {
            renderRoundRobinUI(data);
        } else {
            document.getElementById('advanced-grid-area').innerHTML = '<p style="padding:20px; color:#666;">å°šæœªç”¢ç”Ÿå°æˆ°è¡¨</p>';
            document.getElementById('advanced-standings-body').innerHTML = ''; // æ¸…ç©ºæˆ°ç¸¾æ¦œ
        }
    });

    // --- Render Swiss (Beginner) ---
    function renderSwissUI(category, data) {
        if (data.type !== 'swiss') return;
        const rounds = data.rounds || [];
        const container = document.getElementById(`${category}-swiss-rounds`);
        container.innerHTML = '';

        rounds.forEach((roundMatches, rIdx) => {
            const isLatestRound = (rIdx === rounds.length - 1); // æª¢æŸ¥æ˜¯å¦ç‚ºæœ€å¾Œä¸€è¼ª
            const roundDiv = document.createElement('div');
            roundDiv.className = 'swiss-round-container';
            let roundHtml = `<div class="swiss-round-title">ç¬¬ ${rIdx + 1} è¼ª</div><div style="display:flex; flex-wrap:wrap; gap:10px;">`;
            
            roundMatches.forEach((match, mIdx) => {
                const p1Html = createPlayerHtml(match.p1, match.p2, match.winner, category, rIdx, mIdx, 'p1', isLatestRound);
                const p2Html = createPlayerHtml(match.p2, match.p1, match.winner, category, rIdx, mIdx, 'p2', isLatestRound);
                roundHtml += `<div class="match" style="width:200px;">${p1Html}<div style='border-top:1px solid #eee; margin:2px 0;'></div>${p2Html}</div>`;
            });
            roundHtml += '</div>';
            roundDiv.innerHTML = roundHtml;
            container.appendChild(roundDiv);
        });

        // Standings
        const participants = allUsers.filter(u => u.category === category);
        const stats = {};
        participants.forEach(p => stats[p.id] = { name: p.name, wins: 0, opponents: [], id: p.id });

        rounds.forEach(round => {
            round.forEach(m => {
                if (m.winner) {
                    if (stats[m.winner]) stats[m.winner].wins++;
                    if (m.p1.id !== 'BYE' && m.p2.id !== 'BYE') {
                        if(stats[m.p1.id]) stats[m.p1.id].opponents.push(m.p2.id);
                        if(stats[m.p2.id]) stats[m.p2.id].opponents.push(m.p1.id);
                    }
                }
            });
        });

        const standings = Object.values(stats).map(s => {
            const sos = s.opponents.reduce((acc, oppId) => acc + (stats[oppId] ? stats[oppId].wins : 0), 0);
            return { ...s, sos };
        });

        standings.sort((a, b) => {
            if (b.wins !== a.wins) return b.wins - a.wins;
            return b.sos - a.sos;
        });

        const tbody = document.getElementById(`${category}-standings-body`);
        tbody.innerHTML = '';
        standings.forEach((s, idx) => {
            let rankClass = idx === 0 ? 'rank-1' : idx === 1 ? 'rank-2' : idx === 2 ? 'rank-3' : '';
            const opponentsName = s.opponents.map(oid => stats[oid]?.name).join(', ');
            tbody.innerHTML += `<tr><td class="${rankClass}">#${idx+1}</td><td>${s.name}</td><td>${s.wins}</td><td>${s.sos}</td><td style="font-size:0.8em; color:#666;">${opponentsName}</td></tr>`;
        });
    }

    // --- Render Round Robin (Advanced) ---
    function renderRoundRobinUI(data) {
        if (data.type !== 'round-robin') return;
        const participants = data.participants || [];
        const matches = data.matches || [];

        // Standings
        const stats = {};
        participants.forEach(p => stats[p.id] = { name: p.name, wins: 0, losses: 0, id: p.id });

        matches.forEach(m => {
            if (m.winner) {
                stats[m.winner].wins++;
                const loserId = (m.winner === m.p1.id) ? m.p2.id : m.p1.id;
                stats[loserId].losses++;
            }
        });

        const sortedStats = Object.values(stats).sort((a, b) => {
            if (b.wins !== a.wins) return b.wins - a.wins;
            return a.losses - b.losses;
        });

        const standingsBody = document.getElementById('advanced-standings-body');
        standingsBody.innerHTML = '';
        sortedStats.forEach((s, idx) => {
            let rankClass = idx === 0 ? 'rank-1' : idx === 1 ? 'rank-2' : idx === 2 ? 'rank-3' : '';
            const winRate = (s.wins + s.losses) > 0 ? Math.round((s.wins / (s.wins + s.losses)) * 100) + '%' : '-';
            standingsBody.innerHTML += `
                <tr>
                    <td class="${rankClass}">#${idx + 1}</td>
                    <td>${s.name}</td>
                    <td>${s.wins}</td>
                    <td>${s.losses}</td>
                    <td>${winRate}</td>
                </tr>
            `;
        });

        // Grid
        const gridArea = document.getElementById('advanced-grid-area');
        let gridHtml = '<table class="rr-grid" border="1" style="border-collapse:collapse; width:100%; min-width:600px;">';
        gridHtml += '<tr><th style="background:#eee;">é¸æ‰‹</th>';
        participants.forEach(p => gridHtml += `<th style="background:#eee;">${p.name}</th>`);
        gridHtml += '</tr>';

        participants.forEach((rowP, i) => {
            gridHtml += `<tr><td style="font-weight:bold; background:#fafafa;">${rowP.name}</td>`;
            participants.forEach((colP, j) => {
                if (rowP.id === colP.id) {
                    gridHtml += '<td class="rr-cell-self"></td>';
                } else {
                    const matchIndex = matches.findIndex(m => 
                        (m.p1.id === rowP.id && m.p2.id === colP.id) || 
                        (m.p1.id === colP.id && m.p2.id === rowP.id)
                    );
                    
                    if (matchIndex === -1) {
                        gridHtml += '<td>Error</td>';
                    } else {
                        const match = matches[matchIndex];
                        let cellContent = '-';
                        let cellClass = '';
                        let onClick = isAdmin ? `onclick="window.toggleRRWinner(${matchIndex}, '${rowP.id}')"` : '';

                        if (match.winner) {
                            if (match.winner === rowP.id) {
                                cellContent = 'å‹'; cellClass = 'rr-cell-win';
                            } else {
                                cellContent = 'æ•—'; cellClass = 'rr-cell-loss';
                            }
                        } else {
                            cellContent = 'æœªæˆ°'; cellClass = 'rr-cell-play';
                        }
                        
                        if (isAdmin) cellClass += ' rr-cell-clickable';
                        gridHtml += `<td class="${cellClass}" ${onClick}>${cellContent}</td>`;
                    }
                }
            });
            gridHtml += '</tr>';
        });
        gridHtml += '</table>';
        gridArea.innerHTML = gridHtml;
    }

    // --- Interaction ---
    function createPlayerHtml(player, opponent, matchWinnerId, category, rIdx, mIdx, slot, isLatest = true) {
        let classes = 'player';
        if (player.id === 'BYE') classes += ' bye-text';
        if (matchWinnerId) {
            if (matchWinnerId === player.id) classes += ' winner';
            else classes += ' loser';
        }
        
        let clickAction = '';
        if (isAdmin) {
            if (!isLatest && category === 'beginner') {
                // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€è¼ªï¼Œä¸”æ˜¯ç‘å£«åˆ¶ -> é–å®š
                classes += ' locked';
                clickAction = `onclick="alert('âš ï¸ ç„¡æ³•ä¿®æ”¹æ­·å²è¼ªæ¬¡çš„æˆç¸¾ï¼\\nè‹¥éœ€ä¿®æ­£ï¼Œè«‹é»æ“Šä¸Šæ–¹çš„ã€Œåˆªé™¤æœ€å¾Œä¸€è¼ªã€æŒ‰éˆ•å›æº¯ã€‚')"`
            } else {
                // æ­£å¸¸å¯é»æ“Šç‹€æ…‹
                if (!matchWinnerId && player.id !== 'BYE') {
                    classes += ' clickable';
                    clickAction = `onclick="window.setSwissWinner('${category}', ${rIdx}, ${mIdx}, '${player.id}')"`;
                } else if (matchWinnerId && matchWinnerId === player.id && opponent.id !== 'BYE') {
                    classes += ' undoable';
                    clickAction = `onclick="window.resetSwissMatch('${category}', ${rIdx}, ${mIdx})"`;
                }
            }
        }
        return `<div class="${classes}" ${clickAction}><span>${player.name || '-'}</span></div>`;
    }

    // Global Action Functions
    window.setSwissWinner = function(category, rIdx, mIdx, winnerId) {
        if (!isAdmin || !confirm("ç¢ºèªå‹è² ï¼Ÿ")) return;
        db.ref(`tournament/${category}/rounds/${rIdx}/${mIdx}`).update({ winner: winnerId });
    }
    
    window.resetSwissMatch = function(category, rIdx, mIdx) {
        if (!isAdmin || !confirm("ç¢ºå®šè¦é‡ç½®é€™å ´æ¯”è³½å—ï¼Ÿ")) return;
        db.ref(`tournament/${category}/rounds/${rIdx}/${mIdx}`).update({ winner: null });
    }

    window.toggleRRWinner = function(matchIndex, clickedPlayerId) {
        if (!isAdmin) return;
        if (!bracketData.advanced || !bracketData.advanced.matches) return;
        
        const match = bracketData.advanced.matches[matchIndex];
        let newWinner = null;

        if (!match.winner) newWinner = clickedPlayerId;
        else if (match.winner === clickedPlayerId) newWinner = (match.p1.id === clickedPlayerId) ? match.p2.id : match.p1.id;
        else newWinner = null;

        db.ref(`tournament/advanced/matches/${matchIndex}`).update({ winner: newWinner });
    };
</script>

</body>
</html>