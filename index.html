<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœæ£‹ç¤¾æ¯”è³½å ±åèˆ‡å°æˆ°ç³»çµ± (å®‰å…¨é›œæ¹Šç‰ˆ)</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #d35400;
            --bg: #fdfbf7;
            --board-color: #e6b35c;
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: var(--primary); cursor: pointer; user-select: none; }
        h2 { border-bottom: 2px solid var(--board-color); padding-bottom: 10px; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; background: #eee; border-radius: 5px 5px 0 0; }
        .tab.active { background: var(--primary); color: white; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Form */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { opacity: 0.9; }
        button.danger { background: #c0392b; }
        button.success { background: #27ae60; }
        button.admin-btn { background: var(--accent); display: none; margin-left: 10px; }
        button.logout-btn { background: #7f8c8d; font-size: 0.8em; padding: 5px 10px; margin-top: 5px; }

        /* Admin Controls */
        .admin-controls-panel {
            display: none;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .registration-closed-msg {
            display: none;
            color: #c0392b;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            border: 1px dashed #c0392b;
            background: #fdedec;
            margin-top: 10px;
        }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: var(--primary); color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }

        /* Round Robin Grid Styles */
        .rr-grid th, .rr-grid td { text-align: center; vertical-align: middle; padding: 15px; border: 1px solid #ccc; font-size: 1.1em; }
        .rr-cell-self { background-color: #eee; }
        .rr-cell-win { background-color: #d4edda; color: #155724; font-weight: bold; }
        .rr-cell-loss { background-color: #f8d7da; color: #721c24; }
        .rr-cell-play { background-color: #fff; color: #aaa; } 

        /* ç®¡ç†å“¡äº’å‹•æ¨£å¼ */
        body.is-admin .rr-cell-clickable { 
            cursor: pointer !important; 
            position: relative;
        }
        body.is-admin .rr-cell-clickable:hover { 
            background-color: #ffeaa7 !important; 
            outline: 2px solid var(--accent);
            z-index: 10;
        }

        .rr-standings th { background-color: var(--accent); }
        .rank-1 { color: gold; font-weight: bold; text-shadow: 1px 1px 0 #999; }
        .rank-2 { color: silver; font-weight: bold; text-shadow: 1px 1px 0 #999; }
        .rank-3 { color: #cd7f32; font-weight: bold; text-shadow: 1px 1px 0 #999; }
        
        .playoff-win-text { color: #d35400; font-weight: bold; font-size: 0.9em; }
        .playoff-loss-text { color: #7f8c8d; font-size: 0.9em; }

        /* Tag Styles */
        .tag { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.9em; display: inline-block; font-weight: bold; text-align: center; min-width: 60px;}
        .tag-beginner { background-color: #27ae60; }
        .tag-advanced { background-color: #c0392b; }
        .time-text { font-size: 0.85em; color: #666; }

        /* Admin Mode */
        body.is-admin .admin-btn { display: inline-block; }
        body.is-admin .admin-action { display: table-cell; }
        body.is-admin .admin-controls-panel { display: block; }
        .admin-action { display: none; width: 80px; text-align: center; }
        
        body.is-admin .player.clickable:hover { background-color: #ffeaa7; cursor: pointer; outline: 1px solid orange; }
        body.is-admin .player.undoable:hover { background-color: #ffcccc; cursor: pointer; outline: 1px solid red; }
        
        /* Bracket Styles */
        .bracket-container { display: flex; overflow-x: auto; padding: 20px 0; min-height: 400px; }
        .round { display: flex; flex-direction: column; justify-content: space-around; min-width: 200px; margin-right: 40px; }
        .match { background: #fff; border: 1px solid #ccc; margin: 10px 0; padding: 10px; border-radius: 4px; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .match:hover { border-color: var(--accent); }
        
        .player { padding: 5px; display: flex; justify-content: space-between; align-items: center; cursor: default; border-radius: 3px; }
        .player.winner { font-weight: bold; color: green; }
        .player.loser { color: #999; text-decoration: line-through; }
        .player.bye-text { color: #999; font-style: italic; }
        
        .champion-box { text-align: center; border: 2px solid gold; background: #fffdf0; margin-top: 20px; padding: 20px; display: none; }
        .third-place-container { margin-top: 30px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .third-place-title { font-weight: bold; color: var(--accent); margin-bottom: 10px; }

        .round:not(:first-child) .match::before {
            content: ""; position: absolute; left: -20px; top: 50%; width: 20px; height: 1px; background: #ccc;
        }
        .edit-input { width: 100px; padding: 2px; }
        .admin-select { width: auto; padding: 5px; border-color: var(--accent); }
        
        /* Playoff Section */
        .playoff-area { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        .playoff-controls { margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 5px; display: none; }
        body.is-admin .playoff-controls { display: block; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="appTitle" title="åœæ£‹ç¤¾å…§éƒ¨æ¯”è³½ç³»çµ±">åœæ£‹ç¤¾å…§éƒ¨æ¯”è³½ç³»çµ±</h1>
    <div id="adminStatus" style="text-align:center; color: red; display:none;">
        (ç®¡ç†å“¡æ¨¡å¼å·²å•Ÿç”¨)<br>
        <span style="font-size:0.8em; color:#666;">ğŸ’¡ æç¤ºï¼šå¾ªç’°è³½è«‹ç›´æ¥é»æ“Šã€Œè¡¨æ ¼ä¸­çš„æ ¼å­ã€åˆ‡æ›å‹è² </span><br>
        <button class="logout-btn" onclick="logout()">ç™»å‡ºç®¡ç†å“¡</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('register')">å ±åé é¢</div>
        <div class="tab" onclick="switchTab('list')">å ±ååå–®</div>
        <div class="tab" onclick="switchTab('bracket-beginner')">å…¥é–€çµ„å°æˆ°è¡¨</div>
        <div class="tab" onclick="switchTab('bracket-advanced')">é€²éšçµ„å°æˆ°è¡¨</div>
    </div>

    <div id="register" class="tab-content active">
        <h2>é¸æ‰‹å ±å</h2>
        <div class="admin-controls-panel">
            <strong>ğŸ”§ ç®¡ç†å“¡æ§åˆ¶ï¼š</strong>
            <button class="success" onclick="toggleRegistration(true)">ğŸŸ¢ é–‹å•Ÿå ±å</button>
            <button class="danger" onclick="toggleRegistration(false)">ğŸ”´ æˆªæ­¢å ±å</button>
            <span id="adminRegStatus" style="margin-left:10px; font-weight:bold;"></span>
        </div>

        <div id="registrationForm">
            <div class="form-group">
                <label>çµ„åˆ¥</label>
                <select id="regCategory">
                    <option value="beginner">å…¥é–€çµ„ (å–®æ·˜æ±°)</option>
                    <option value="advanced">é€²éšçµ„ (å¾ªç’°è³½)</option>
                </select>
            </div>
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="regName" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <div class="form-group">
                <label>å·¥è™Ÿ</label>
                <input type="text" id="regEmpId" placeholder="è«‹è¼¸å…¥å·¥è™Ÿ">
            </div>
            <button id="submitBtn" onclick="submitRegistration()">æäº¤å ±å</button>
        </div>

        <div id="regClosedMsg" class="registration-closed-msg">
            âš ï¸ ç›®å‰å ±åå·²æˆªæ­¢ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚
        </div>
    </div>

    <div id="list" class="tab-content">
        <h2>å·²å ±ååå–®</h2>
        <table>
            <thead>
                <tr>
                    <th style="width: 120px;">çµ„åˆ¥</th>
                    <th>å§“å</th>
                    <th>å·¥è™Ÿ</th>
                    <th>å ±åæ™‚é–“</th>
                    <th class="admin-action">ç®¡ç†æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="registrantsTable"></tbody>
        </table>
    </div>

    <div id="bracket-beginner" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>å…¥é–€çµ„ å°æˆ°è¡¨ (å–®æ•—æ·˜æ±°)</h2>
            <div>
                <button class="admin-btn danger" onclick="clearBracket('beginner')">ğŸ—‘ï¸ æ¸…ç©ºå°æˆ°è¡¨</button>
                <button class="admin-btn" onclick="generateBracket('beginner')">é‡æ–°ç”¢ç”Ÿ</button>
            </div>
        </div>
        <div id="beginner-bracket-area" class="bracket-container"></div>
        <div id="beginner-3rd-place" class="third-place-container" style="display:none;">
            <div class="third-place-title">å­£æ®¿è»è³½</div>
            <div id="beginner-3rd-match"></div>
        </div>
        <div id="beginner-champion" class="champion-box"></div>
    </div>

    <div id="bracket-advanced" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>é€²éšçµ„ å°æˆ°è¡¨ (å¾ªç’°è³½)</h2>
            <div>
                <button class="admin-btn danger" onclick="clearBracket('advanced')">ğŸ—‘ï¸ æ¸…ç©ºå°æˆ°è¡¨</button>
                <button class="admin-btn" onclick="generateBracket('advanced')">é‡æ–°ç”¢ç”Ÿ</button>
            </div>
        </div>
        
        <h3>ğŸ† æˆ°ç¸¾æ’è¡Œæ¦œ</h3>
        <table class="rr-standings">
            <thead>
                <tr>
                    <th>åæ¬¡</th>
                    <th>å§“å</th>
                    <th>å‹</th>
                    <th>æ•—</th>
                    <th>å‹ç‡</th>
                    <th>å‚™è¨»</th>
                </tr>
            </thead>
            <tbody id="advanced-standings-body"></tbody>
        </table>

        <h3>âš”ï¸ å°æˆ°çŸ©é™£</h3>
        <p style="font-size:0.9em; color:#666;">(æ©«åˆ—ç‚ºé¸æ‰‹ï¼Œç›´æ¬„ç‚ºå°æ‰‹ã€‚è‹¥æ‚¨æ˜¯ç®¡ç†å“¡ï¼Œè«‹é»æ“Šæ ¼å­åˆ‡æ›ï¼šå‹ -> æ•— -> æœªæˆ°)</p>
        <div id="advanced-grid-area" style="overflow-x: auto;"></div>

        <div class="playoff-area">
            <h3>ğŸ”¥ åŠ è³½å€ (å¹³æ‰‹æ™‚ä½¿ç”¨)</h3>
            <div class="playoff-controls">
                <label>æ–°å¢åŠ è³½å ´æ¬¡ï¼š</label>
                <select id="playoffP1"></select> VS <select id="playoffP2"></select>
                <button onclick="addPlayoffMatch()">æ–°å¢å ´æ¬¡</button>
            </div>
            <div id="advanced-playoff-matches" class="bracket-container" style="min-height: auto;"></div>
        </div>
    </div>
</div>

<script>
    // 1. åˆå§‹åŒ–è®Šæ•¸
    let clickCount = 0;
    let isAdmin = false;
    let isRegistrationOpen = true; 
    let allUsers = [];
    let cacheBeginnerData = null;
    let cacheAdvancedData = null;
    
    const targetHash = "43b2d122712ab1d4778f7d4ff86337f7c9aeb6d5e3ac0d0626e7288258f6a836";

    const firebaseConfig = {
        apiKey: "AIzaSyDNmDH2jTCu9miZtzTM73H1gLYJ3EOazsQ",
        authDomain: "go-club-818e2.firebaseapp.com",
        databaseURL: "https://go-club-818e2-default-rtdb.firebaseio.com",
        projectId: "go-club-818e2",
        storageBucket: "go-club-818e2.firebasestorage.app",
        messagingSenderId: "818869551072",
        appId: "1:818869551072:web:8408991a2dedd1f9e1b585",
        measurementId: "G-3S2G8R5QJD"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. å•Ÿå‹•é‚è¼¯
    if (localStorage.getItem('goClubAdmin') === 'true') {
        enableAdminMode();
    }

    db.ref('config/registrationOpen').on('value', (snapshot) => {
        const val = snapshot.val();
        isRegistrationOpen = (val === null) ? true : val;
        updateRegistrationUI();
    });

    // 3. ç®¡ç†å“¡åŠŸèƒ½ (å« Hash é©—è­‰)
    
    async function sha256(message) {
        // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´
        if (!window.crypto || !window.crypto.subtle) {
            alert("âš ï¸ å®‰å…¨è­¦å‘Šï¼šæ‚¨çš„ç€è¦½å™¨æˆ–åŸ·è¡Œç’°å¢ƒ (å¦‚ç›´æ¥é–‹å•Ÿ file://) ä¸æ”¯æ´åŠ å¯†åŠŸèƒ½ã€‚\nç„¡æ³•é©—è­‰å¯†ç¢¼ï¼Œè«‹ä½¿ç”¨ Local Server é–‹å•Ÿç¶²é ã€‚");
            throw new Error("Crypto API not available");
        }
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    }

    document.getElementById('appTitle').addEventListener('click', async () => {
        clickCount++;
        if (clickCount === 16) {
            if (isAdmin) return; 
            
            const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
            if (pwd) {
                try {
                    const inputHash = await sha256(pwd);
                    if (inputHash === targetHash) {
                        enableAdminMode();
                        alert("ç®¡ç†å“¡æ¨¡å¼å·²é–‹å•Ÿ");
                    } else {
                        alert("å¯†ç¢¼éŒ¯èª¤");
                    }
                } catch (e) {
                    console.error("Hash Error:", e);
                }
            }
            clickCount = 0;
        }
    });

    function enableAdminMode() {
        isAdmin = true;
        localStorage.setItem('goClubAdmin', 'true');
        document.body.classList.add('is-admin');
        document.getElementById('adminStatus').style.display = 'block';
        updateRegistrationUI();
        renderList();
        refreshBrackets(); 
    }

    function logout() {
        isAdmin = false;
        localStorage.removeItem('goClubAdmin');
        document.body.classList.remove('is-admin');
        document.getElementById('adminStatus').style.display = 'none';
        updateRegistrationUI();
        renderList();
        refreshBrackets(); 
    }

    function toggleRegistration(status) {
        db.ref('config/registrationOpen').set(status);
        alert(status ? "å ±åå·²é–‹å•Ÿ" : "å ±åå·²æˆªæ­¢");
    }

    function updateRegistrationUI() {
        const formDiv = document.getElementById('registrationForm');
        const closedMsg = document.getElementById('regClosedMsg');
        const adminStatusLabel = document.getElementById('adminRegStatus');
        
        adminStatusLabel.innerText = isRegistrationOpen ? "(ç›®å‰ç‹€æ…‹ï¼šé–‹å•Ÿ)" : "(ç›®å‰ç‹€æ…‹ï¼šæˆªæ­¢)";
        adminStatusLabel.style.color = isRegistrationOpen ? "green" : "red";

        if (isAdmin) {
            formDiv.style.display = 'block';
            closedMsg.style.display = 'none';
        } else {
            if (isRegistrationOpen) {
                formDiv.style.display = 'block';
                closedMsg.style.display = 'none';
            } else {
                formDiv.style.display = 'none';
                closedMsg.style.display = 'block';
            }
        }
    }

    function refreshBrackets() {
        if(cacheBeginnerData) renderBracketUI('beginner', cacheBeginnerData);
        if(cacheAdvancedData) renderAdvancedUI(cacheAdvancedData);
    }

    // 4. ä¸€èˆ¬åŠŸèƒ½
    function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const tabs = ['register', 'list', 'bracket-beginner', 'bracket-advanced'];
        const index = tabs.indexOf(tabId);
        document.querySelectorAll('.tab')[index].classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    function submitRegistration() {
        if (!isRegistrationOpen && !isAdmin) {
            alert("æŠ±æ­‰ï¼Œå ±åå·²æˆªæ­¢ã€‚");
            return;
        }

        const name = document.getElementById('regName').value.trim();
        const empId = document.getElementById('regEmpId').value.trim();
        const category = document.getElementById('regCategory').value;

        if (!name || !empId) {
            alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
            return;
        }

        const isDuplicate = allUsers.some(u => u.empId === empId);
        if (isDuplicate) {
            alert("æ­¤å·¥è™Ÿå·²å ±åéï¼Œè«‹å‹¿é‡è¤‡å ±åï¼");
            return;
        }

        const newUserRef = db.ref('users').push();
        newUserRef.set({
            name: name,
            empId: empId,
            category: category,
            timestamp: new Date().toISOString()
        }).then(() => {
            alert("å ±åæˆåŠŸï¼");
            document.getElementById('regName').value = '';
            document.getElementById('regEmpId').value = '';
            switchTab('list');
        });
    }

    db.ref('users').on('value', (snapshot) => {
        const data = snapshot.val();
        allUsers = [];
        if (data) {
            Object.keys(data).forEach(key => {
                allUsers.push({ id: key, ...data[key] });
            });
        }
        renderList();
    });

    function renderList() {
        const tbody = document.getElementById('registrantsTable');
        tbody.innerHTML = '';
        allUsers.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        allUsers.forEach(user => {
            const dateStr = new Date(user.timestamp).toLocaleString('zh-TW');
            const isBeginner = user.category === 'beginner';
            const catClass = isBeginner ? 'tag-beginner' : 'tag-advanced';
            const catText = isBeginner ? 'å…¥é–€' : 'é€²éš';

            let categoryHtml;
            if (isAdmin) {
                categoryHtml = `
                    <select class="admin-select" onchange='updateUser("${user.id}", "category", this.value)'>
                        <option value="beginner" ${user.category === 'beginner' ? 'selected' : ''}>å…¥é–€çµ„</option>
                        <option value="advanced" ${user.category === 'advanced' ? 'selected' : ''}>é€²éšçµ„</option>
                    </select>
                `;
            } else {
                categoryHtml = `<span class="tag ${catClass}">${catText}</span>`;
            }

            let row = `<tr>
                <td>${categoryHtml}</td>
                <td>${isAdmin ? `<input class='edit-input' value='${user.name}' onchange='updateUser("${user.id}", "name", this.value)'>` : user.name}</td>
                <td>${isAdmin ? `<input class='edit-input' value='${user.empId}' onchange='updateUser("${user.id}", "empId", this.value)'>` : user.empId}</td>
                <td class="time-text">${dateStr}</td>
                <td class="admin-action">
                    <button class="danger" onclick="deleteUser('${user.id}')">åˆªé™¤</button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function updateUser(id, field, value) {
        db.ref('users/' + id).update({ [field]: value });
    }

    function deleteUser(id) {
        if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ä½å ±åè€…å—ï¼Ÿ")) {
            db.ref('users/' + id).remove();
        }
    }

    // 5. å°æˆ°è¡¨ç”Ÿæˆ
    function clearBracket(category) {
        if (!confirm(`ç¢ºå®šè¦æ¸…ç©ºã€${category === 'beginner' ? 'å…¥é–€çµ„' : 'é€²éšçµ„'}ã€‘çš„å°æˆ°è¡¨å—ï¼Ÿ\n(å ±åè³‡æ–™æœƒä¿ç•™)`)) return;
        db.ref(`tournament/${category}`).remove().then(() => {
            alert("å°æˆ°è¡¨å·²æ¸…ç©º");
        });
    }

    function generateBracket(category) {
        if (!confirm("ç¢ºå®šè¦é‡æ–°ç”¢ç”Ÿå°æˆ°è¡¨å—ï¼Ÿé€™å°‡æ¸…é™¤ç›®å‰çš„æ¯”è³½é€²åº¦ï¼")) return;

        let participants = allUsers.filter(u => u.category === category).map(u => ({ name: u.name, id: u.id }));
        
        if (participants.length < 2) {
            alert("äººæ•¸ä¸è¶³ï¼Œç„¡æ³•ç”¢ç”Ÿå°æˆ°è¡¨");
            return;
        }

        if (category === 'advanced') {
            generateRoundRobin(participants);
        } else {
            generateElimination(participants);
        }
    }

    function generateElimination(participants) {
        for (let i = participants.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [participants[i], participants[j]] = [participants[j], participants[i]];
        }

        let size = 1;
        while (size < participants.length) size *= 2;
        
        const numByes = size - participants.length;
        const numMatches = size / 2;

        let byePriority = [];
        if (numMatches === 16) byePriority = [0, 15, 8, 7, 4, 11, 12, 3, 2, 13, 10, 5, 6, 9, 14, 1];
        else if (numMatches === 8) byePriority = [0, 7, 4, 3, 2, 5, 6, 1];
        else if (numMatches === 4) byePriority = [0, 3, 2, 1];
        else for(let i=0; i<numMatches; i++) byePriority.push(i);

        const round1Matches = [];
        for (let i = 0; i < numMatches; i++) round1Matches.push({ p1: null, p2: null, winner: null });

        const matchesWithBye = new Set(byePriority.slice(0, numByes));

        let playerIdx = 0;
        for (let i = 0; i < numMatches; i++) {
            if (matchesWithBye.has(i)) {
                if (playerIdx < participants.length) {
                    round1Matches[i].p1 = participants[playerIdx++];
                    round1Matches[i].p2 = { name: "è¼ªç©º", id: "BYE" };
                    round1Matches[i].winner = round1Matches[i].p1.id;
                }
            } else {
                if (playerIdx < participants.length) round1Matches[i].p1 = participants[playerIdx++];
                if (playerIdx < participants.length) round1Matches[i].p2 = participants[playerIdx++];
            }
        }

        const rounds = [round1Matches];
        let nextSize = numMatches / 2;
        while (nextSize >= 1) {
            let nextRound = [];
            for (let i = 0; i < nextSize; i++) nextRound.push({ p1: {name: "TBD", id:null}, p2: {name: "TBD", id:null}, winner: null });
            rounds.push(nextRound);
            nextSize /= 2;
        }

        db.ref(`tournament/beginner`).set({
            type: 'elimination',
            rounds: rounds,
            thirdPlace: { p1: null, p2: null, winner: null },
            timestamp: Date.now()
        });
    }

    function generateRoundRobin(participants) {
        let matches = [];
        for (let i = 0; i < participants.length; i++) {
            for (let j = i + 1; j < participants.length; j++) {
                matches.push({
                    p1: participants[i],
                    p2: participants[j],
                    winner: null
                });
            }
        }

        db.ref(`tournament/advanced`).set({
            type: 'round-robin',
            participants: participants,
            matches: matches,
            playoffs: [], 
            timestamp: Date.now()
        });
    }

    // 6. æ¸²æŸ“é‚è¼¯
    db.ref('tournament/beginner').on('value', snapshot => {
        cacheBeginnerData = snapshot.val();
        try {
            if (cacheBeginnerData) renderBracketUI('beginner', cacheBeginnerData);
            else clearUI('beginner');
        } catch (e) {
            console.error("Beginner Render Error:", e);
        }
    });

    db.ref('tournament/advanced').on('value', snapshot => {
        cacheAdvancedData = snapshot.val();
        try {
            if (cacheAdvancedData) renderAdvancedUI(cacheAdvancedData);
            else clearUI('advanced');
        } catch (e) {
            console.error("Advanced Render Error:", e);
            document.getElementById(`advanced-grid-area`).innerHTML = '<p style="padding:20px; color:red;">âš ï¸ è³‡æ–™æ ¼å¼ä¸ç¬¦</p>';
        }
    });

    function clearUI(category) {
        if(category === 'beginner') {
            document.getElementById(`beginner-bracket-area`).innerHTML = '<p style="padding:20px; color:#666;">å°šæœªç”¢ç”Ÿå°æˆ°è¡¨</p>';
            document.getElementById(`beginner-3rd-place`).style.display = 'none';
            document.getElementById(`beginner-champion`).style.display = 'none';
        } else {
            document.getElementById(`advanced-grid-area`).innerHTML = '<p style="padding:20px; color:#666;">å°šæœªç”¢ç”Ÿå°æˆ°è¡¨</p>';
            document.getElementById(`advanced-standings-body`).innerHTML = '';
        }
    }

    function renderBracketUI(category, data) {
        if(data.type !== 'elimination' && data.rounds === undefined) return;
        const rounds = data.rounds;
        const container = document.getElementById(`${category}-bracket-area`);
        container.innerHTML = '';
        
        rounds.forEach((roundMatches, roundIndex) => {
            const roundDiv = document.createElement('div');
            roundDiv.className = 'round';
            
            roundMatches.forEach((match, matchIndex) => {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'match';
                
                if (roundIndex > 0) {
                    const prevRound = rounds[roundIndex - 1];
                    const p1Match = prevRound[matchIndex * 2];
                    const p2Match = prevRound[matchIndex * 2 + 1];

                    if (p1Match && p1Match.winner) match.p1 = (p1Match.winner === p1Match.p1.id) ? p1Match.p1 : p1Match.p2;
                    else match.p1 = { name: "ç­‰å¾…ä¸­...", id: null };

                    if (p2Match && p2Match.winner) match.p2 = (p2Match.winner === p2Match.p1.id) ? p2Match.p1 : p2Match.p2;
                    else match.p2 = { name: "ç­‰å¾…ä¸­...", id: null };
                }

                const p1Html = createPlayerHtml(match.p1, match.p2, match.winner, category, roundIndex, matchIndex, 'p1');
                const p2Html = createPlayerHtml(match.p2, match.p1, match.winner, category, roundIndex, matchIndex, 'p2');
                
                matchDiv.innerHTML = p1Html + `<div style='border-top:1px solid #eee; margin:2px 0;'></div>` + p2Html;
                roundDiv.appendChild(matchDiv);
            });
            container.appendChild(roundDiv);
        });

        const finalRoundIndex = rounds.length - 1;
        const finalMatch = rounds[finalRoundIndex][0];
        const champDiv = document.getElementById(`${category}-champion`);
        
        if (finalMatch.winner && finalMatch.winner !== 'BYE') {
            const champion = (finalMatch.winner === finalMatch.p1.id) ? finalMatch.p1 : finalMatch.p2;
            const runnerUp = (finalMatch.winner === finalMatch.p1.id) ? finalMatch.p2 : finalMatch.p1;
            champDiv.style.display = 'block';
            champDiv.innerHTML = `<h3>ğŸ† å† è»ï¼š${champion.name}</h3><h4>ğŸ¥ˆ äºè»ï¼š${runnerUp.name}</h4>`;
        } else {
            champDiv.style.display = 'none';
        }

        if (rounds.length >= 2) {
            const semiRound = rounds[rounds.length - 2];
            const semi1 = semiRound[0];
            const semi2 = semiRound[1];

            if (semi1.winner && semi2.winner) {
                const loser1 = (semi1.winner === semi1.p1.id) ? semi1.p2 : semi1.p1;
                const loser2 = (semi2.winner === semi2.p1.id) ? semi2.p2 : semi2.p1;

                if (loser1.id !== 'BYE' && loser2.id !== 'BYE') {
                    const thirdContainer = document.getElementById(`${category}-3rd-place`);
                    thirdContainer.style.display = 'block';
                    const thirdMatchDiv = document.getElementById(`${category}-3rd-match`);
                    
                    const p1 = loser1;
                    const p2 = loser2;
                    const winner = data.thirdPlace ? data.thirdPlace.winner : null;

                    const tp1Html = createPlayerHtml(p1, p2, winner, category, 'third', 0, 'p1');
                    const tp2Html = createPlayerHtml(p2, p1, winner, category, 'third', 0, 'p2');
                    thirdMatchDiv.innerHTML = `<div class="match" style="width:200px;">${tp1Html}<div style='border-top:1px solid #eee; margin:2px 0;'></div>${tp2Html}</div>`;
                    
                    // ä¿®å¾©å­£æ®¿è»é¡¯ç¤º
                    if (winner) {
                        const p3 = (winner === p1.id) ? p1.name : p2.name;
                        const p4 = (winner === p1.id) ? p2.name : p1.name;
                        champDiv.innerHTML += `<h4>ğŸ¥‰ å­£è»ï¼š${p3}</h4><h4>æ®¿è»ï¼š${p4}</h4>`;
                    }
                }
            }
        }
    }

    function renderAdvancedUI(data) {
        if (data.type !== 'round-robin') {
            document.getElementById(`advanced-grid-area`).innerHTML = '<div style="text-align:center; padding:20px; color:red;">âš ï¸ è³‡æ–™æ ¼å¼ä¸ç¬¦</div>';
            return;
        }

        const participants = data.participants || [];
        const matches = data.matches || [];
        const playoffs = data.playoffs || [];

        // 1. ç©åˆ†è¨ˆç®— (åŒ…å«åŠ è³½ç´€éŒ„æ¨™è¨˜)
        const stats = {};
        participants.forEach(p => stats[p.id] = { 
            name: p.name, 
            wins: 0, 
            losses: 0, 
            id: p.id,
            playoffStatus: null // 'win' or 'loss' or null
        });

        matches.forEach(m => {
            if (m.winner) {
                stats[m.winner].wins++;
                const loserId = (m.winner === m.p1.id) ? m.p2.id : m.p1.id;
                stats[loserId].losses++;
            }
        });

        // æ¨™è¨˜åŠ è³½çµæœ
        playoffs.forEach(m => {
            if(m.winner) {
                if(stats[m.winner]) stats[m.winner].playoffStatus = 'win';
                
                const loserId = (m.winner === m.p1.id) ? m.p2.id : m.p1.id;
                if(stats[loserId]) stats[loserId].playoffStatus = 'loss';
            }
        });

        // æ’åºé‚è¼¯ï¼šå‹å ´ > æ•—å ´ > åŠ è³½å°æˆ°çµæœ
        const sortedStats = Object.values(stats).sort((a, b) => {
            if (b.wins !== a.wins) return b.wins - a.wins;
            if (a.losses !== b.losses) return a.losses - b.losses;

            // 3. å¹³æ‰‹ï¼æª¢æŸ¥åŠ è³½ç´€éŒ„
            const playoffMatch = playoffs.find(m => 
                (m.p1.id === a.id && m.p2.id === b.id) || 
                (m.p1.id === b.id && m.p2.id === a.id)
            );

            if (playoffMatch && playoffMatch.winner) {
                return (playoffMatch.winner === a.id) ? -1 : 1;
            }

            return 0;
        });

        const standingsBody = document.getElementById('advanced-standings-body');
        standingsBody.innerHTML = '';
        sortedStats.forEach((s, idx) => {
            let rankClass = '';
            if (idx === 0) rankClass = 'rank-1';
            if (idx === 1) rankClass = 'rank-2';
            if (idx === 2) rankClass = 'rank-3';
            
            const totalGames = s.wins + s.losses;
            const winRate = totalGames > 0 ? Math.round((s.wins / totalGames) * 100) + '%' : '-';

            let note = '';
            if(s.playoffStatus === 'win') note = '<span class="playoff-win-text">ğŸ”¥ åŠ è³½å‹</span>';
            if(s.playoffStatus === 'loss') note = '<span class="playoff-loss-text">ğŸ’€ åŠ è³½æ•—</span>';

            standingsBody.innerHTML += `
                <tr>
                    <td class="${rankClass}">#${idx + 1}</td>
                    <td>${s.name}</td>
                    <td>${s.wins}</td>
                    <td>${s.losses}</td>
                    <td>${winRate}</td>
                    <td>${note}</td>
                </tr>
            `;
        });

        // 2. Grid (Cross Table)
        const gridArea = document.getElementById('advanced-grid-area');
        let gridHtml = '<table class="rr-grid" border="1" style="border-collapse:collapse; width:100%; min-width:600px;">';
        
        gridHtml += '<tr><th style="background:#eee;">é¸æ‰‹</th>';
        participants.forEach(p => gridHtml += `<th style="background:#eee;">${p.name}</th>`);
        gridHtml += '</tr>';

        participants.forEach((rowP, i) => {
            gridHtml += `<tr><td style="font-weight:bold; background:#fafafa;">${rowP.name}</td>`;
            participants.forEach((colP, j) => {
                if (rowP.id === colP.id) {
                    gridHtml += '<td class="rr-cell-self"></td>';
                } else {
                    const matchIndex = matches.findIndex(m => 
                        (m.p1.id === rowP.id && m.p2.id === colP.id) || 
                        (m.p1.id === colP.id && m.p2.id === rowP.id)
                    );
                    
                    if (matchIndex === -1) {
                        gridHtml += '<td>Error</td>';
                    } else {
                        const match = matches[matchIndex];
                        let cellContent = '-';
                        let cellClass = '';
                        
                        let onClick = isAdmin ? `onclick="window.toggleRRWinner(${matchIndex}, '${rowP.id}')"` : '';

                        if (match.winner) {
                            if (match.winner === rowP.id) {
                                cellContent = 'å‹';
                                cellClass = 'rr-cell-win';
                            } else {
                                cellContent = 'æ•—';
                                cellClass = 'rr-cell-loss';
                            }
                        } else {
                            cellContent = 'æœªæˆ°';
                            cellClass = 'rr-cell-play';
                        }
                        
                        if (isAdmin) {
                            cellClass += ' rr-cell-clickable';
                        }

                        gridHtml += `<td class="${cellClass}" ${onClick}>${cellContent}</td>`;
                    }
                }
            });
            gridHtml += '</tr>';
        });
        gridHtml += '</table>';
        gridArea.innerHTML = gridHtml;

        // 3. Playoff Dropdowns
        const p1Select = document.getElementById('playoffP1');
        const p2Select = document.getElementById('playoffP2');
        if (p1Select.options.length === 0) { 
            p1Select.innerHTML = '';
            p2Select.innerHTML = '';
            participants.forEach(p => {
                p1Select.add(new Option(p.name, JSON.stringify(p)));
                p2Select.add(new Option(p.name, JSON.stringify(p)));
            });
        }

        // 4. Render Playoffs
        const playoffContainer = document.getElementById('advanced-playoff-matches');
        playoffContainer.innerHTML = '';
        if (playoffs.length > 0) {
            playoffs.forEach((match, idx) => {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'match';
                matchDiv.style.margin = '5px 10px';
                
                const p1Html = createPlayerHtml(match.p1, match.p2, match.winner, 'advanced', 'playoff', idx, 'p1');
                const p2Html = createPlayerHtml(match.p2, match.p1, match.winner, 'advanced', 'playoff', idx, 'p2');
                let delBtn = isAdmin ? `<button onclick="deletePlayoff(${idx})" style="float:right; background:none; border:none; color:red; cursor:pointer;">x</button>` : '';

                matchDiv.innerHTML = `${delBtn}${p1Html}<div style='border-top:1px solid #eee; margin:2px 0;'></div>${p2Html}`;
                playoffContainer.appendChild(matchDiv);
            });
        }
    }

    // 7. äº’å‹•æ“ä½œ
    function createPlayerHtml(player, opponent, matchWinnerId, category, rIdx, mIdx, slot) {
        let classes = 'player';
        if (player.id === 'BYE') classes += ' bye-text';
        if (matchWinnerId) {
            if (matchWinnerId === player.id) classes += ' winner';
            else classes += ' loser';
        }
        let clickAction = '';
        if (isAdmin) {
            if (rIdx === 'playoff') {
                if (!matchWinnerId || (matchWinnerId === player.id)) {
                     classes += ' clickable';
                     clickAction = `onclick="setPlayoffWinner(${mIdx}, '${player.id}')"`;
                }
            } else {
                const opponentId = opponent ? opponent.id : null;
                if (!matchWinnerId && player.id && player.id !== 'BYE' && opponentId) {
                    classes += ' clickable';
                    clickAction = `onclick="setWinner('${category}', '${rIdx}', ${mIdx}, '${player.id}')"`;
                } else if (matchWinnerId && matchWinnerId === player.id && opponentId !== 'BYE') {
                    classes += ' undoable';
                    clickAction = `onclick="resetMatch('${category}', '${rIdx}', ${mIdx})"`;
                }
            }
        }
        return `<div class="${classes}" ${clickAction}><span>${player.name || '-'}</span></div>`;
    }

    window.toggleRRWinner = function(matchIndex, clickedPlayerId) {
        if (!isAdmin) return;

        console.log(`Grid Clicked: ${matchIndex}, Player: ${clickedPlayerId}`);

        if (!cacheAdvancedData || !cacheAdvancedData.matches) {
            console.error("No match data found");
            return;
        }

        const match = cacheAdvancedData.matches[matchIndex];
        let newWinner = null;

        if (!match.winner) {
            newWinner = clickedPlayerId;
        } else if (match.winner === clickedPlayerId) {
            newWinner = (match.p1.id === clickedPlayerId) ? match.p2.id : match.p1.id;
        } else {
            newWinner = null;
        }

        db.ref(`tournament/advanced/matches/${matchIndex}`).update({ winner: newWinner })
            .then(() => console.log("Update Success"))
            .catch(err => alert("Update Error: " + err.message));
    };

    function setWinner(category, roundIdx, matchIdx, winnerId) {
        if (!confirm("ç¢ºèªè©²é¸æ‰‹ç²å‹å—ï¼Ÿ")) return;
        if (roundIdx === 'third') {
            db.ref(`tournament/${category}/thirdPlace`).update({ winner: winnerId });
        } else {
            roundIdx = parseInt(roundIdx);
            db.ref(`tournament/${category}/rounds/${roundIdx}/${matchIdx}`).update({ winner: winnerId });
            db.ref(`tournament/${category}`).once('value').then(snap => {
                const data = snap.val();
                const rounds = data.rounds;
                if (roundIdx + 1 < rounds.length) {
                    const nextMatchIdx = Math.floor(matchIdx / 2);
                    const nextSlot = (matchIdx % 2 === 0) ? 'p1' : 'p2';
                    const currentMatch = rounds[roundIdx][matchIdx];
                    const winnerObj = (currentMatch.p1.id === winnerId) ? currentMatch.p1 : currentMatch.p2;
                    db.ref(`tournament/${category}/rounds/${roundIdx + 1}/${nextMatchIdx}/${nextSlot}`).set(winnerObj);
                }
                if (roundIdx === rounds.length - 2) {
                     const currentMatch = rounds[roundIdx][matchIdx];
                     const loserObj = (currentMatch.p1.id === winnerId) ? currentMatch.p2 : currentMatch.p1;
                     const thirdSlot = (matchIdx === 0) ? 'p1' : 'p2';
                     db.ref(`tournament/${category}/thirdPlace/${thirdSlot}`).set(loserObj);
                }
            });
        }
    }

    function resetMatch(category, roundIdx, matchIdx) {
        if (!confirm("âš ï¸ ç¢ºå®šè¦å–æ¶ˆæ­¤å±€å‹è² å—ï¼Ÿ\n(é€™æœƒå°‡æ­¤å±€é‡ç½®ç‚ºæœªå°æˆ°ç‹€æ…‹)")) return;
        if (roundIdx === 'third') { db.ref(`tournament/${category}/thirdPlace`).update({ winner: null }); return; }
        roundIdx = parseInt(roundIdx);
        db.ref(`tournament/${category}`).once('value').then(snap => {
            const data = snap.val();
            const rounds = data.rounds;
            if (roundIdx + 1 < rounds.length) {
                const nextMatchIdx = Math.floor(matchIdx / 2);
                if (rounds[roundIdx + 1][nextMatchIdx].winner) { alert("ğŸš« ç„¡æ³•å–æ¶ˆï¼šä¸‹ä¸€è¼ªå·²æœ‰æ¯”è³½çµæœã€‚"); return; }
            }
            db.ref(`tournament/${category}/rounds/${roundIdx}/${matchIdx}`).update({ winner: null });
            if (roundIdx + 1 < rounds.length) {
                const nextMatchIdx = Math.floor(matchIdx / 2);
                const nextSlot = (matchIdx % 2 === 0) ? 'p1' : 'p2';
                db.ref(`tournament/${category}/rounds/${roundIdx + 1}/${nextMatchIdx}/${nextSlot}`).set({ name: "TBD", id: null });
            }
            if (roundIdx === rounds.length - 2) {
                 const thirdSlot = (matchIdx === 0) ? 'p1' : 'p2';
                 db.ref(`tournament/${category}/thirdPlace/${thirdSlot}`).set({ name: "TBD", id: null });
                 db.ref(`tournament/${category}/thirdPlace`).update({ winner: null });
            }
        });
    }

    function addPlayoffMatch() {
        const p1Data = JSON.parse(document.getElementById('playoffP1').value);
        const p2Data = JSON.parse(document.getElementById('playoffP2').value);
        if (p1Data.id === p2Data.id) { alert("ä¸èƒ½é¸æ“‡åŒä¸€äººå°æˆ°"); return; }
        let playoffs = cacheAdvancedData.playoffs || [];
        playoffs.push({ p1: p1Data, p2: p2Data, winner: null });
        db.ref(`tournament/advanced/playoffs`).set(playoffs);
    }

    function setPlayoffWinner(matchIdx, winnerId) {
        const match = cacheAdvancedData.playoffs[matchIdx];
        let newWinner = winnerId;
        if (match.winner === winnerId) newWinner = null;
        db.ref(`tournament/advanced/playoffs/${matchIdx}`).update({ winner: newWinner });
    }

    function deletePlayoff(idx) {
        if(!confirm("ç¢ºå®šåˆªé™¤é€™å ´åŠ è³½ï¼Ÿ")) return;
        let playoffs = cacheAdvancedData.playoffs;
        playoffs.splice(idx, 1);
        db.ref(`tournament/advanced/playoffs`).set(playoffs);
    }
</script>

</body>
</html>